{% extends "base.html" %}

{% block title %}External Scanner - Product App{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">External Product Scanner</h1>
    <p class="text-muted">Scan an FNSKU to lookup product information from external database</p>

    <!-- Scanner Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">FNSKU Scanner</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="camera-select">Select Camera:</label>
                <select id="camera-select" class="form-control" style="max-width: 500px; margin-bottom: 10px;"></select>
            </div>

            <div id="reader" style="width: 100%; max-width: 500px; margin: auto; position: relative; background: black; border-radius: 8px; overflow: hidden; min-height: 400px;">
                <video id="video" style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);" playsinline autoplay muted></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                    <div style="width: 250px; height: 250px; border: 3px solid #10b981; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
                </div>
                <div id="status" style="position: absolute; top: 10px; left: 10px; background: rgba(16, 185, 129, 0.9); color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px; display: none;">
                    <span id="status-text">Scanning...</span>
                </div>
            </div>
            <div id="scan-result" class="mt-3 text-center"></div>
            
            <div class="text-center mt-3">
                <button id="start-scan-btn" class="btn btn-primary mr-2">Start Scan</button>
                <button id="stop-scan-btn" class="btn btn-danger mr-2" style="display: none;">Stop Scan</button>
                <button id="manual-input-btn" class="btn btn-secondary">Manual Input</button>
            </div>

            <div class="alert alert-info mt-3" role="alert">
                <i class="fas fa-info-circle"></i>
                Point your device's camera at an FNSKU barcode to lookup product information from external database.
            </div>
        </div>
    </div>

    <!-- Manual Input Section -->
    <div class="card mb-4" id="manual-input-section" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Manual FNSKU Input</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="manual-fnsku">Enter FNSKU:</label>
                <div class="input-group">
                    <input type="text" id="manual-fnsku" class="form-control" placeholder="Enter FNSKU here" style="text-transform: uppercase;">
                    <div class="input-group-append">
                        <button id="lookup-btn" class="btn btn-primary">Lookup</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="card" id="results-section" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Product Information</h5>
        </div>
        <div class="card-body" id="product-details">
            <!-- Results will be populated here -->
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="text-center" id="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Looking up product information...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
// Import ZXing library - using browser-compatible import
import { BrowserMultiFormatReader, NotFoundException } from 'https://unpkg.com/@zxing/library@latest/esm/index.js';

document.addEventListener('DOMContentLoaded', (event) => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraSelect = document.getElementById('camera-select');
    const startScanButton = document.getElementById('start-scan-btn');
    const stopScanButton = document.getElementById('stop-scan-btn');
    const manualInputBtn = document.getElementById('manual-input-btn');
    const manualInputSection = document.getElementById('manual-input-section');
    const manualFnskuInput = document.getElementById('manual-fnsku');
    const lookupBtn = document.getElementById('lookup-btn');
    const scanResultDiv = document.getElementById('scan-result');
    const resultsSection = document.getElementById('results-section');
    const productDetails = document.getElementById('product-details');
    const loadingSpinner = document.getElementById('loading-spinner');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    
    let currentStream = null;
    let scanInterval = null;
    let reader = null;
    let hasScanned = false;

    // Initialize ZXing reader
    reader = new BrowserMultiFormatReader();

    async function getCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${cameraSelect.options.length + 1}`;
                cameraSelect.appendChild(option);
            });
            
            // Select rear camera if available
            if (videoDevices.length > 0) {
                const rearCamera = videoDevices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));
                if (rearCamera) {
                    cameraSelect.value = rearCamera.deviceId;
                } else {
                    cameraSelect.value = videoDevices[videoDevices.length - 1].deviceId;
                }
            }
        } catch (err) {
            console.error('Error getting cameras:', err);
            scanResultDiv.innerHTML = `<p class="text-danger">Error getting cameras: ${err.message}</p>`;
        }
    }

    async function startScan(cameraId) {
        try {
            hasScanned = false;
            statusDiv.style.display = 'block';
            statusText.textContent = 'Scanning...';
            scanResultDiv.innerHTML = '<p class="text-info">Starting camera...</p>';

            // Optimal camera constraints
            const constraints = {
                video: {
                    deviceId: cameraId ? { exact: cameraId } : undefined,
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    facingMode: { ideal: 'environment' },
                    aspectRatio: { ideal: 16/9 },
                    frameRate: { ideal: 60, min: 30 },
                    focusMode: 'continuous',
                    exposureMode: 'continuous',
                    whiteBalanceMode: 'continuous'
                }
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            
            // Wait for video to be ready
            await new Promise((resolve) => {
                if (video.readyState >= 2) {
                    resolve();
                } else {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                }
            });

            await video.play();

            // Apply additional constraints after stream starts
            const videoTrack = currentStream.getVideoTracks()[0];
            if (videoTrack) {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities?.focusMode?.includes('continuous')) {
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ focusMode: 'continuous' }]
                        });
                    } catch (err) {
                        console.warn('Could not set continuous focus:', err);
                    }
                }
            }

            // Start scanning loop - 50ms = 20 scans per second
            scanInterval = setInterval(async () => {
                if (hasScanned || video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }

                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const result = await reader.decodeFromCanvas(canvas);

                    if (result && result.getText()) {
                        const fnsku = result.getText().trim().toUpperCase();
                        hasScanned = true;
                        stopScan();
                        scanResultDiv.innerHTML = `<p class="text-success">FNSKU scanned: ${fnsku}</p>`;
                        performExternalLookup(fnsku);
                    }
                } catch (err) {
                    // NotFoundException is expected when no barcode is found
                    if (!(err instanceof NotFoundException)) {
                        console.warn('Scan error:', err);
                    }
                }
            }, 50);

            startScanButton.style.display = 'none';
            stopScanButton.style.display = 'inline-block';
            cameraSelect.disabled = true;
            scanResultDiv.innerHTML = '<p class="text-info">Scanning for FNSKU...</p>';
        } catch (err) {
            console.error('Error starting camera:', err);
            scanResultDiv.innerHTML = `<p class="text-danger">Error starting camera: ${err.message}</p>`;
            statusDiv.style.display = 'none';
            cameraSelect.disabled = false;
        }
    }

    function stopScan() {
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }

        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }

        if (video) {
            video.srcObject = null;
            video.load();
        }

        statusDiv.style.display = 'none';
        startScanButton.style.display = 'inline-block';
        stopScanButton.style.display = 'none';
        cameraSelect.disabled = false;
        hasScanned = false;
    }

    function performExternalLookup(fnsku) {
        loadingSpinner.style.display = 'block';
        resultsSection.style.display = 'none';
        
        // Convert to uppercase before sending
        const upperFnsku = fnsku.trim().toUpperCase();
        
        fetch('/api/external-lookup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ fnsku: upperFnsku })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            
            if (data.success) {
                displayProductInfo(data);
            } else {
                displayError(data.message || 'Failed to lookup product information');
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('Error:', error);
            displayError('Network error occurred while looking up product information');
        });
    }

    function displayProductInfo(data) {
        const sourceMessage = data.source === 'local_database' 
            ? '<div class="alert alert-success"><i class="fas fa-database"></i> Found in local database - no API charge</div>'
            : '<div class="alert alert-warning"><i class="fas fa-cloud"></i> Retrieved from fnskutoasin.com API - charged lookup</div>';
        
        const html = `
            ${sourceMessage}
            <div class="row">
                <div class="col-md-3">
                    ${data.image_url ? `<img src="${data.image_url}" class="img-fluid rounded" alt="Product Image">` : '<div class="bg-light p-4 text-center rounded"><i class="fas fa-image fa-3x text-muted"></i><br>No Image</div>'}
                </div>
                <div class="col-md-9">
                    <h5>${data.title || 'No title available'}</h5>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>FNSKU:</strong></td>
                            <td>${data.fnsku}</td>
                        </tr>
                        <tr>
                            <td><strong>ASIN:</strong></td>
                            <td>${data.asin || 'Not available'}</td>
                        </tr>
                        ${data.lpn ? `<tr><td><strong>LPN:</strong></td><td>${data.lpn}</td></tr>` : ''}
                        ${data.price ? `<tr><td><strong>Price:</strong></td><td>$${data.price}</td></tr>` : ''}
                        <tr>
                            <td><strong>Source:</strong></td>
                            <td>${data.source === 'local_database' ? 'Local Inventory Database' : 'fnskutoasin.com API'}</td>
                        </tr>
                        ${data.scan_task_id ? `<tr><td><strong>Scan Task ID:</strong></td><td>${data.scan_task_id}</td></tr>` : ''}
                        ${data.task_state ? `<tr><td><strong>Task State:</strong></td><td><span class="badge badge-info">${data.task_state}</span></td></tr>` : ''}
                        ${data.assignment_date ? `<tr><td><strong>Assignment Date:</strong></td><td>${new Date(data.assignment_date).toLocaleString()}</td></tr>` : ''}
                    </table>
                    <div class="mt-3">
                        ${data.amazon_url ? `<a href="${data.amazon_url}" target="_blank" class="btn btn-warning mr-2"><i class="fab fa-amazon"></i> View on Amazon</a>` : ''}
                        ${data.source === 'external_api' && data.saved_to_local ? '<span class="badge badge-success">Saved to local database</span>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        productDetails.innerHTML = html;
        resultsSection.style.display = 'block';
    }

    function displayError(message) {
        const html = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </div>
        `;
        productDetails.innerHTML = html;
        resultsSection.style.display = 'block';
    }

    // Initialize cameras
    getCameras();

    // Event listeners
    startScanButton.addEventListener('click', () => {
        const cameraId = cameraSelect.value;
        if (!cameraId) {
            scanResultDiv.innerHTML = '<p class="text-warning">Please select a camera.</p>';
            return;
        }
        startScan(cameraId);
    });

    stopScanButton.addEventListener('click', () => {
        stopScan();
        scanResultDiv.innerHTML = '<p>Scanner stopped.</p>';
    });

    manualInputBtn.addEventListener('click', () => {
        if (manualInputSection.style.display === 'none') {
            manualInputSection.style.display = 'block';
            manualInputBtn.textContent = 'Hide Manual Input';
        } else {
            manualInputSection.style.display = 'none';
            manualInputBtn.textContent = 'Manual Input';
        }
    });

    lookupBtn.addEventListener('click', () => {
        const fnsku = manualFnskuInput.value.trim().toUpperCase();
        if (fnsku) {
            performExternalLookup(fnsku);
        } else {
            alert('Please enter an FNSKU');
        }
    });

    manualFnskuInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            lookupBtn.click();
        }
    });

    cameraSelect.addEventListener('change', () => {
        if (stopScanButton.style.display !== 'none') {
            stopScan();
            setTimeout(() => {
                startScan(cameraSelect.value);
            }, 100);
        }
    });
});
</script>
{% endblock %}
