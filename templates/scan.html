{% extends "base.html" %}

{% block title %}Scan Barcode - Product App{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Scan Product Barcode</h1>

    <div class="form-group">
        <label for="camera-select">Select Camera:</label>
        <select id="camera-select" class="form-control" style="max-width: 500px; margin-bottom: 10px;"></select>
    </div>

    <div id="reader" style="width: 100%; max-width: 500px; margin: auto; position: relative; background: black; border-radius: 8px; overflow: hidden; min-height: 400px;">
        <video id="video" style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);" playsinline autoplay muted></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none;">
            <div style="width: 250px; height: 250px; border: 3px solid #10b981; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
        </div>
        <div id="status" style="position: absolute; top: 10px; left: 10px; background: rgba(16, 185, 129, 0.9); color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px; display: none;">
            <span id="status-text">Scanning...</span>
        </div>
    </div>
    <div id="scan-result" class="mt-3 text-center"></div>
    
    <div class="text-center mt-3">
        <button id="start-scan-btn" class="btn btn-primary mr-2">Start Scan</button>
        <button id="stop-scan-btn" class="btn btn-danger" style="display: none;">Stop Scan</button>
    </div>

    <div class="alert alert-info mt-3" role="alert">
        Point your device's camera at a barcode (LPN, ASIN, or FNSKU).
        Once a barcode is detected, you will be redirected to the search page.
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
// Import ZXing library - using browser-compatible import
import { BrowserMultiFormatReader, NotFoundException } from 'https://unpkg.com/@zxing/library@latest/esm/index.js';

document.addEventListener('DOMContentLoaded', (event) => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraSelect = document.getElementById('camera-select');
    const startScanButton = document.getElementById('start-scan-btn');
    const stopScanButton = document.getElementById('stop-scan-btn');
    const scanResultDiv = document.getElementById('scan-result');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    
    let currentStream = null;
    let scanInterval = null;
    let reader = null;
    let hasScanned = false;

    // Initialize ZXing reader
    reader = new BrowserMultiFormatReader();

    async function getCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${cameraSelect.options.length + 1}`;
                cameraSelect.appendChild(option);
            });
            
            // Select rear camera if available
            if (videoDevices.length > 0) {
                const rearCamera = videoDevices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));
                if (rearCamera) {
                    cameraSelect.value = rearCamera.deviceId;
                } else {
                    cameraSelect.value = videoDevices[videoDevices.length - 1].deviceId;
                }
            }
        } catch (err) {
            console.error('Error getting cameras:', err);
            scanResultDiv.innerHTML = `<p class="text-danger">Error getting cameras: ${err.message}</p>`;
        }
    }

    async function startScan(cameraId) {
        try {
            hasScanned = false;
            statusDiv.style.display = 'block';
            statusText.textContent = 'Scanning...';
            scanResultDiv.innerHTML = '<p class="text-info">Starting camera...</p>';

            // Optimal camera constraints
            const constraints = {
                video: {
                    deviceId: cameraId ? { exact: cameraId } : undefined,
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    facingMode: { ideal: 'environment' },
                    aspectRatio: { ideal: 16/9 },
                    frameRate: { ideal: 60, min: 30 },
                    focusMode: 'continuous',
                    exposureMode: 'continuous',
                    whiteBalanceMode: 'continuous'
                }
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            
            // Wait for video to be ready
            await new Promise((resolve) => {
                if (video.readyState >= 2) {
                    resolve();
                } else {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                }
            });

            await video.play();

            // Apply additional constraints after stream starts
            const videoTrack = currentStream.getVideoTracks()[0];
            if (videoTrack) {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities?.focusMode?.includes('continuous')) {
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ focusMode: 'continuous' }]
                        });
                    } catch (err) {
                        console.warn('Could not set continuous focus:', err);
                    }
                }
            }

            // Start scanning loop - 50ms = 20 scans per second
            scanInterval = setInterval(async () => {
                if (hasScanned || video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }

                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const result = await reader.decodeFromCanvas(canvas);

                    if (result && result.getText()) {
                        const code = result.getText().trim();
                        hasScanned = true;
                        stopScan();
                        scanResultDiv.innerHTML = `<p class="text-success">Scan successful! Redirecting...</p>`;
                        
                        // Redirect to search page
                        window.location.href = "{{ url_for('search') }}?query=" + encodeURIComponent(code);
                    }
                } catch (err) {
                    // NotFoundException is expected when no barcode is found
                    if (!(err instanceof NotFoundException)) {
                        console.warn('Scan error:', err);
                    }
                }
            }, 50);

            startScanButton.style.display = 'none';
            stopScanButton.style.display = 'inline-block';
            cameraSelect.disabled = true;
            scanResultDiv.innerHTML = '<p class="text-info">Scanning...</p>';
        } catch (err) {
            console.error('Error starting camera:', err);
            scanResultDiv.innerHTML = `<p class="text-danger">Error starting camera: ${err.message}</p>`;
            statusDiv.style.display = 'none';
            cameraSelect.disabled = false;
        }
    }

    function stopScan() {
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }

        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }

        if (video) {
            video.srcObject = null;
            video.load();
        }

        statusDiv.style.display = 'none';
        startScanButton.style.display = 'inline-block';
        stopScanButton.style.display = 'none';
        cameraSelect.disabled = false;
        hasScanned = false;
    }

    // Initialize cameras
    getCameras();

    // Event listeners
    startScanButton.addEventListener('click', () => {
        const cameraId = cameraSelect.value;
        if (!cameraId) {
            scanResultDiv.innerHTML = '<p class="text-warning">Please select a camera.</p>';
            return;
        }
        startScan(cameraId);
    });

    stopScanButton.addEventListener('click', () => {
        stopScan();
        scanResultDiv.innerHTML = '<p>Scanner stopped.</p>';
    });

    cameraSelect.addEventListener('change', () => {
        if (stopScanButton.style.display !== 'none') {
            stopScan();
            setTimeout(() => {
                startScan(cameraSelect.value);
            }, 100);
        }
    });
});
</script>
{% endblock %}
